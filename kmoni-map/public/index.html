<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Real-time JMA Intensity Map</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}
#map {
  width: 100%;
  height: 100%;
}
.info {
  position: absolute;
  top: 10px;
  left: 10px;
  background: white;
  padding: 6px 10px;
  font-size: 14px;
  z-index: 1000;
}
</style>
</head>

<body>
<div id="map"></div>
<div class="info">JMA 실시간 계측진도 (Kyoshin Monitor)</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([36.5, 138], 5);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

let markers = new Map();

function intensityColor(i) {
  if (i >= 6.5) return "#6a1b9a";
  if (i >= 6.0) return "#8e24aa";
  if (i >= 5.5) return "#d32f2f";
  if (i >= 5.0) return "#f44336";
  if (i >= 4.0) return "#ff9800";
  if (i >= 3.0) return "#ffeb3b";
  if (i >= 2.0) return "#8bc34a";
  if (i >= 1.0) return "#4caf50";
  return "#bdbdbd";
}

async function update() {
  const res = await fetch("/kmoni");
  const data = await res.json();

  for (const id in data.points) {
    const p = data.points[id];
    if (p.intensity < 0) continue;

    const color = intensityColor(p.intensity);

    if (markers.has(id)) {
      markers.get(id).setStyle({ fillColor: color });
    } else {
      const marker = L.circleMarker([p.lat, p.lon], {
        radius: 5,
        color: "#000",
        weight: 0.5,
        fillColor: color,
        fillOpacity: 0.9
      })
      .bindPopup(`진도 ${p.intensity.toFixed(1)}`)
      .addTo(map);

      markers.set(id, marker);
    }
  }
}

update();
setInterval(update, 1000);
</script>
</body>
</html>
